name: "Publish NuGet Packages"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: "The run ID to use for downloading artifacts"
        required: true
  workflow_call:
    inputs:
      run_id:
        required: true
        type: string

permissions:
  contents: write

jobs:
  publish:
    name: "Publish NuGet Packages"
    runs-on: ubuntu-24.04
    steps:
      - name: Download NuGet artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run download "${{ inputs.run_id }}" --repo ${{ github.repository }} --pattern "nuget-package-*" --dir staging

      - name: Publish NuGet Packages
        run: |
          # Collect all packages
          mapfile -t packages < <(find staging -type f -name "*.nupkg")

          # Push each package to NuGet.org
          for package in "${packages[@]}"; do
            echo "Publishing package: $package"
            dotnet nuget push "$package" --source "https://api.nuget.org/v3/index.json" --api-key "$NUGET_API_KEY"
          done
        env:
          NUGET_API_KEY: ${{ secrets.RELEASE_NUGET_API_KEY }}

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Uploading NuGet packages to GitHub release..."
          shopt -s nullglob
          packages=(staging/**/*.nupkg)
          if [ ${#packages[@]} -eq 0 ]; then
            echo "Error: No NuGet packages found"
            exit 1
          fi
          for package in "${packages[@]}"; do
            echo "Uploading $(basename "$package")..."
            gh release upload "${{ github.ref_name }}" "$package" --repo ${{ github.repository }}
          done
