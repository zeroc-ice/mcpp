name: "Publish RPM Packages"

on:
  workflow_dispatch:
    inputs:
      channel:
        description: "The Ice release channel (e.g., 3.7, 3.8)"
        required: true
      run_id:
        description: "The run ID to use for downloading artifacts"
        required: true
  workflow_call:
    inputs:
      channel:
        required: true
        type: string
      run_id:
        required: true
        type: string

permissions:
  contents: write

jobs:
  publish:
    name: "Publish RPM Packages"
    runs-on: ubuntu-24.04
    steps:
      - name: Download RPM artifacts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run download "${{ inputs.run_id }}" --repo ${{ github.repository }} --pattern "rpm-packages-${{ inputs.channel }}-*" --dir staging

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Uploading RPM packages to GitHub release..."
          shopt -s nullglob
          dirs=(staging/rpm-packages-*/)
          if [ ${#dirs[@]} -eq 0 ]; then
            echo "Error: No RPM artifacts found"
            exit 1
          fi
          for dir in "${dirs[@]}"; do
            artifact_name=$(basename "$dir")
            echo "Creating ${artifact_name}.zip..."
            pushd "$dir" > /dev/null
            zip -r "../${artifact_name}.zip" .
            popd > /dev/null
            echo "Uploading ${artifact_name}.zip..."
            gh release upload "${{ github.ref_name }}" "staging/${artifact_name}.zip" --repo ${{ github.repository }}
          done
